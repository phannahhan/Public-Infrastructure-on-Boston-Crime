---
title: "graphics"
author: "Hannah Phan"
date: "March 20, 2020"
output: html_document
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(tidycensus)
library(janitor)
library(gt)
library(haven)
library(infer)
library(fivethirtyeight)
options(scipen = 999)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggspatial)
require(maps)
require(ggmap)
options(tigris_class = "sf")
library(tigris)
options(tigris_use_cache = TRUE)
library(gganimate)
theme_set(theme_bw())
```

```{r data, include = FALSE, cache = T}
bluebikes <- read_csv("raw-data/current_bluebikes_stations.csv", skip = 1, col_types = cols()) %>%
  clean_names()

streetlights <- read_csv("raw-data/streetlight-locations.csv", col_types = cols()) %>%
  clean_names()

parkboston2015 <- read_csv("raw-data/park-boston-monthly-transactions-by-zone-2015.csv", col_types = cols()) %>%
  clean_names()

parkingtickets2014 <- read_csv("raw-data/parking-tickets-portal-web-statistics.csv", col_types = cols()) %>%
  clean_names()

trafficdata2014 <- read_csv("raw-data/trafficdata.csv", col_types = cols())

trash <- read_csv("raw-data/big-belly-locations.csv", col_types = cols())

crime <- read_csv("raw-data/tmpgwmn6nt4.csv", col_types = cols())%>%
  na.omit()
  

trees <- read_csv("raw-data/Trees.csv", col_types = cols())

hubway <- read_csv("raw-data/Hubway_Stations.csv", col_types = cols())
```

```{r bluebikes map, echo = FALSE}
## I used instructions from
## https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html. I realized I only
## wanted to map within a specific latitudinal/longitudinal range because the
## bluebike data is only for the city of Boston. To determine the range, I
## sorted the bluebikes table by latitude in descending order, and then by
## longitude. Once I made the map, to plot the locations of the bikes, I used
## geom_point. I also added the locations for the streetlights in a separate
## map, but I realized there's a higher density of streetlights than bluebikes,
## so I'll need to restyle the map for the next milestone.

# Used tidycensus for map of Boston; superimposed bike, tree, streetlight, and
# crime data over it.

# finding the average crime levels in areas with concentrated lights, bluebikes,
# trees, trash receptacles, traffic statistical aspect can come from calculating
# the densities, and then computing the correlation amongst densities. gganimate
# of crime over time. Color dots, or size the dots based off of severity of
# crime. Need to clean crime data to remove na values, maps for bikes and lights
# need to show points. Facet wrap by type of crime. Group crime by year.

census_api_key("9f9584127dd506cdaf80bdb78927e9c01c12f2b8", install = T, overwrite = T)

suffolk <- get_acs(geography = "tract",
                  variables = c(medincome = "B19013_001"), 
                  year = 2018,
                  state = "MA",
                  county = "Suffolk County",
                  geometry = TRUE)

suffolk_map <- suffolk %>%
  ggplot() +
  geom_sf() +
  coord_sf(xlim = c(-71.168, -71.005), ylim = c(42.266, 42.415), 
           expand = FALSE) +
  scale_fill_viridis_c(direction = -1) +
  scale_color_viridis_c(direction = -1) +
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(2.8, "in"), pad_y = unit(0.1, "in"),
                         style = north_arrow_fancy_orienteering) +
  scale_x_continuous(breaks = seq(-71.16, -71.01, by = .03))


bluebike_map <- suffolk_map +
  ggtitle("Bluebike Map of Suffolk County, MA") +
  coord_sf(xlim = c(-71.168, -71.005), ylim = c(42.266, 42.415), 
           expand = FALSE) +
  geom_point(bluebikes, mapping = aes(longitude, latitude), color = "blue") +
  scale_x_continuous(breaks = seq(-71.16, -71.01, by = .03))

streetlight_map <- suffolk_map +
  geom_sf(color = "black", fill = "black") +
  geom_point(streetlights, mapping = aes(long, lat), color = "yellow", alpha = 0.01) +
  labs(title = "Streetlight Map of Suffolk County, MA",
       caption = "Source: Boston Analyze Streetlight Data",
       x = "Longitude",
       y = "Latitude")

tree_map <- suffolk_map +
  geom_point(trees, mapping = aes(X, Y), color = "dark green", alpha = 0.01) +
  labs(title = "Tree Map of Suffolk County, MA",
       caption = "Source: Boston Analyze Public Tree Data 2011",
       x = "Longitude",
       y = "Latitude")

trash_map <- suffolk_map +
  geom_point(trees, mapping = aes(X, Y), color = "purple", alpha = 0.01) +
  labs(title = "Trash Receptacle Map of Suffolk County, MA",
       caption = "Source: Department of Innovation and Technology Public Big Belly Data")

crime_map <- suffolk_map +
  geom_sf(color = "black", fill = "lightgreen") +
  labs(title = "Crime Map of Suffolk County, MA",
       caption = "Source: ANALYZE BOSTON CRIME INCIDENT REPORTS (AUGUST 2015 - TO DATE)") +
  coord_sf(xlim = c(-71.168, -71.005), ylim = c(42.266, 42.415), 
           expand = FALSE) +
  geom_point(crime, mapping = aes(Long, Lat), color = "red", alpha = 0.01)

suffolk_map
bluebike_map
streetlight_map
tree_map
trash_map
crime_map

# look into cex argument to adjust size of the dots? check out social explorer
# or american census data to see how many commuters are in the area ACS survey,
# adjust alpha level = 0.5 to overlay the dots
# For milestone 6 try making a shiny app with an animated graph that shows the
# crime over the years

# https://gis.harvard.edu/
# https://www.r-bloggers.com/drug-crime-density-in-boston/
# https://stablemarkets.wordpress.com/2014/09/01/spatial-data-visualization-with-r/
# http://bcb.dfci.harvard.edu/~aedin/courses/R/CDC/maps.html 
# https://data.boston.gov/ 
```

```{r shinygraph, include = FALSE}

# To make my shiny app, I followed the same format as ps6 to save my desired
# graphic into a file in a folder in my repo and then rendered that image in the
# app.R file. I want to build onto this by adding animations.

bluebike_streetlight_map %>%
ggsave(filename = file.path("final_project_shiny","bluebike_streetlight_map.png"))

```
link to shiny app: https://hannah-phan.shinyapps.io/final_project_shiny/

```{r crime density plot}

violentcrimes <- crime %>%
  filter(OFFENSE_CODE_GROUP == "Aggravated Assault" 
         & OFFENSE_CODE_GROUP == "Homicide" & OFFENSE_CODE_GROUP == "Robbery")
                   
suffolk_map + stat_density2d(data = violentcrimes,
                mapping = aes(x = Long, y = Lat, alpha=.75, fill=..level..),
                 bins = 8,
                 geom = 'polygon') +
  guides(fill = guide_colorbar(barwidth = 1, barheight = 10)) +
  geom_point(data = violentcrimes, 
             aes(x = Long, y = Lat),
             col='gray', alpha=.5,size=1) +
  scale_alpha(guide = FALSE) +
  xlab('')+ylab('') +
  ggtitle('Crimes - 2015 to 2020 - Boston, MA')

density <- ggplot(violentcrimes, mapping = aes(Long, Lat)) +
  geom_point(col='gray', alpha=.5,size=1) +
  stat_density2d(violentcrimes, alpha=.75, mapping = aes(fill=..density..),
                 bins = 8,
                 geom = 'polygon') +
  guides(fill = guide_colorbar(barwidth = 1, barheight = 10))


  scale_alpha(guide = FALSE) +
  xlab('')+ylab('') +
  ggtitle('Crimes - 2015 to 2020 - Boston, MA')
```


```{r animate crime}
# need to have year object from crime, but map takes suffolk data

suffolk_crime_map + transition_time(YEAR) + 
  labs(title = "Year: {frame_time}")
```

```{r statistical graphs}
# finding the average crime levels in areas with concentrated lights, bluebikes,
# trees, trash receptacles, traffic statistical aspect can come from calculating
# the densities, and then computing the correlation amongst densities. gganimate
# of crime over time. Color dots, or size the dots based off of severity of
# crime. Need to clean crime data to remove na values, maps for bikes and lights
# need to show points. Facet wrap by type of crime. Group crime by year.
# The most difficult aspect was calculating the densities. I needed to make a
# decision on how I wanted to segment the map to calculate the densities of each
# amenity for that segmented area. At first, I wanted to divide the map into a
# square grid and calculate the densities of each square, but then I realized
# that squares that included land outside of Suffolk County would inaccurately
# have a lower density of each amenity, so I made the decision to pick areas
# that only included Suffolk County, counting the number of amenities and
# dividing it by the unit of land to get concentration/density.

crime_count_zone <- crime %>%
  mutate(zone = case_when(
    Long > -71.16 & Long < -71.13 & Lat > 42.26 & Lat < 42.28 ~ "zone1",
    Long > -71.13 & Long < -71.10 & Lat > 42.26 & Lat < 42.28 ~ "zone2",
    Long > -71.10 & Long < -71.07 & Lat > 42.26 & Lat < 42.28 ~ "zone3",
    Long > -71.07 & Long < -71.04 & Lat > 42.26 & Lat < 42.28 ~ "zone4",
    Long > -71.16 & Long < -71.13 & Lat > 42.28 & Lat < 42.3 ~ "zone5",
    Long > -71.13 & Long < -71.10 & Lat > 42.28 & Lat < 42.3 ~ "zone6",
    Long > -71.10 & Long < -71.07 & Lat > 42.28 & Lat < 42.3 ~ "zone7",
    Long > -71.07 & Long < -71.04 & Lat > 42.28 & Lat < 42.3 ~ "zone8",
    Long > -71.13 & Long < -71.10 & Lat > 42.3 & Lat < 42.32 ~ "zone9",
    Long > -71.10 & Long < -71.07 & Lat > 42.3 & Lat < 42.32 ~ "zone10",
    Long > -71.07 & Long < -71.04 & Lat > 42.3 & Lat < 42.32 ~ "zone11",
    Long > -71.13 & Long < -71.10 & Lat > 42.32 & Lat < 42.34 ~ "zone12",
    Long > -71.10 & Long < -71.07 & Lat > 42.32 & Lat < 42.34 ~ "zone13",
    Long > -71.07 & Long < -71.04 & Lat > 42.32 & Lat < 42.34 ~ "zone14",
    Long > -71.16 & Long < -71.13 & Lat > 42.34 & Lat < 42.36 ~ "zone15",
    Long > -71.10 & Long < -71.07 & Lat > 42.34 & Lat < 42.36 ~ "zone16",
    Long > -71.07 & Long < -71.04 & Lat > 42.34 & Lat < 42.36 ~ "zone17",
    Long > -71.04 & Long < -71.01 & Lat > 42.34 & Lat < 42.36 ~ "zone18",
    Long > -71.07 & Long < -71.04 & Lat > 42.36 & Lat < 42.38 ~ "zone19",
    Long > -71.04 & Long < -71.01 & Lat > 42.36 & Lat < 42.38 ~ "zone20",
    Long > -71.04 & Long < -71.01 & Lat > 42.38 & Lat < 42.40 ~ "zone21")) %>%
  filter(!is.na(zone))




```

